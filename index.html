<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ§¼ ì§§ì€ ê·¸ë¦¼ ì„¸íƒì†Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-color: #f8f9fa; --text-color: #212529; --border-color: #dee2e6;
      --section-bg: #ffffff; --btn-bg: #e9ecef; --btn-hover-bg: #dee2e6;
      --accent-btn-bg: #228be6; --accent-btn-hover-bg: #1c7ed6;
    }
    body.dark {
      --bg-color: #121212; --text-color: #e9ecef; --border-color: #343a40;
      --section-bg: #1e1e1e; --btn-bg: #343a40; --btn-hover-bg: #495057;
    }
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding: 20px;
      background-color: var(--bg-color); color: var(--text-color);
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: 700px;
      background-color: var(--section-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    h1 { text-align: center; margin-top: 0; }
    p.subtitle { color: var(--key-color, #868e96); line-height: 1.6; text-align: center; margin-bottom: 30px; }
    .upload-box {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 40px 20px;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      text-align: center;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 200px;
    }
    .upload-box:hover, .upload-box.dragover { background-color: var(--bg-color); border-color: var(--accent-btn-bg); }
    #file-input { display: none; }
    
    /* âœ¨ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
    #workspace {
        text-align: center; /* ìì‹ ìš”ì†Œ(ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ) ì¤‘ì•™ ì •ë ¬ */
    }
    #image-preview-container {
      position: relative;
      margin-top: 10px;
      line-height: 0; /* ì´ë¯¸ì§€ í•˜ë‹¨ ì—¬ë°± ì œê±° */
      display: inline-block; /* ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ì»¨í…Œì´ë„ˆ í¬ê¸° ì¡°ì ˆ */
    }
    #image-preview {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        display: block;
    }
    #watermark-preview-canvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none; /* ìº”ë²„ìŠ¤ í´ë¦­ ë°©ì§€ */
        border-radius: 8px;
    }

    .controls-panel { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; text-align: left; } /* ì œì–´íŒì€ ì™¼ìª½ ì •ë ¬ */
    .control-group { background: var(--bg-color); padding: 20px; border-radius: 8px; }
    .control-group h3 { margin-top: 0; margin-bottom: 15px; }
    label { font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 5px; }
    input[type="text"], input[type="number"] {
      width: 100%; box-sizing: border-box; padding: 8px; font-size: 0.9rem;
      border: 1px solid var(--border-color); border-radius: 6px;
      background-color: var(--input-bg, #fff); color: inherit;
    }
    .input-row { display: flex; gap: 10px; align-items: center; }
    .input-row input { flex: 1; }
    .input-row button { padding: 8px; font-size: 1rem; background: var(--btn-bg); color: var(--text-color); width: 40px; flex-shrink: 0; border:none; border-radius: 6px; cursor: pointer;}
    .position-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .position-grid button { padding: 8px; font-size: 1.2rem; background: var(--btn-bg); color: var(--text-color); border:none; cursor: pointer;}
    .position-grid button.active { background: var(--accent-btn-bg); color: #fff; }
    .download-buttons { display: flex; gap: 10px; margin-top: 15px; }
    .download-buttons button { flex: 1; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }
    .header-controls { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100;}
    
    .header-controls button {
        background-color: var(--btn-bg);
        color: var(--text-color);
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .header-controls button:hover {
        background-color: var(--btn-hover-bg);
    }

    .stepper { display:flex; align-items: center; gap: 5px; }
    .stepper input { text-align: center; }
    .stepper-btns { display:flex; flex-direction: column; }
    .stepper-btns button { padding: 1px 6px; font-size: 0.8rem; height: 18px; width: 25px; background: var(--btn-bg); color: var(--text-color); border:none; border-radius: 4px; }
    #change-image-btn { width: 100%; margin-top: 20px; background-color: var(--btn-bg); color: var(--text-color); border:none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1.0rem; }
  </style>
</head>
<body>
  <div class="header-controls">
    <button id="main-link" title="ëŒì•„ê°€ê¸°">ğŸï¸</button>
    <button id="toggleDarkBtn" title="ë‹¤í¬ëª¨ë“œ">ğŸŒ—</button>
  </div>
  <div class="container">
    <h1>ğŸ§¼ ì§§ì€ ê·¸ë¦¼ ì„¸íƒì†Œ</h1>
    <p class="subtitle" id="subtitle">ğŸ¨ JPG ë³€í™˜ ì €ì¥(ë©”íƒ€ë°ì´í„° ì œê±°)<br>+ ğŸ§µ ì›Œí„°ë§ˆí¬ ì¶”ê°€</p>
    
    <div id="upload-box" class="upload-box">
      <span id="upload-text">ğŸ–¼ï¸ ì´ê³³ì„ í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</span>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display: none;">
    
    <div id="workspace" style="display:none;">
        <button id="change-image-btn">ğŸ–¼ï¸ ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ë³€ê²½</button>
        <div id="image-preview-container"></div>
        <div class="download-buttons">
            <button id="wash-btn" title="ì›Œí„°ë§ˆí¬ ì—†ì´ ë©”íƒ€ë°ì´í„°ë§Œ ì œê±°í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.">ğŸ¨ ë¹¨ë˜</button>
            <button id="repair-btn" title="í˜„ì¬ ì„¤ì •ëœ ì›Œí„°ë§ˆí¬ë¥¼ ì¶”ê°€í•˜ê³  ë©”íƒ€ë°ì´í„°ë¥¼ ì œê±°í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.">ğŸ§µ ìˆ˜ì„ </button>
        </div>
        <div id="controls-panel" class="controls-panel">
            <div class="control-group">
                <h3>ì´ë¯¸ì§€ í¬ê¸°</h3>
                <div class="input-row">
                  <input type="number" id="img-width" placeholder="ë„ˆë¹„">
                  <button id="aspect-lock" title="ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ ê³ ì •">ğŸ”’</button>
                  <input type="number" id="img-height" placeholder="ë†’ì´">
                </div>
            </div>

            <div class="control-group">
                <h3>ì›Œí„°ë§ˆí¬ ì„¤ì •</h3>
                <label for="watermark-text">ë¬¸êµ¬</label>
                 <div class="input-row">
                    <input type="text" id="watermark-text">
                    <button id="clear-text-btn" title="ë¬¸êµ¬ ì§€ìš°ê¸°">ğŸ—‘ï¸</button>
                    <button id="restore-text-btn" title="ê¸°ë³¸ê°’ ë³µêµ¬">ğŸ”„</button>
                </div>
                
                <label for="watermark-position" style="margin-top:15px;">ìœ„ì¹˜</label>
                <div class="position-grid" id="watermark-position">
                  <button data-position="pattern" title="íŒ¨í„´">â˜</button>
                  <button data-position="center" class="active" title="ì¤‘ì•™">ï¼‹</button>
                  <button data-position="top-left" title="ì¢Œì¸¡ ìƒë‹¨">â†–</button>
                  <button data-position="top" title="ìƒë‹¨">â†‘</button>
                  <button data-position="top-right" title="ìš°ì¸¡ ìƒë‹¨">â†—</button>
                  <button data-position="left" title="ì¢Œì¸¡">â†</button>
                  <button data-position="right" title="ìš°ì¸¡">â†’</button>
                  <button data-position="bottom-left" title="ì¢Œì¸¡ í•˜ë‹¨">â†™</button>
                  <button data-position="bottom-right" title="ìš°ì¸¡ í•˜ë‹¨">â†˜</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label>í¬ê¸°</label>
                        <div class="stepper">
                           <input type="number" id="font-size-input" value="30" min="10" max="200" step="5">
                           <div class="stepper-btns"><button data-input="font-size-input" data-step="5">ğŸ”¼</button><button data-input="font-size-input" data-step="-5">ğŸ”½</button></div>
                        </div>
                    </div>
                    <div>
                        <label>íˆ¬ëª…ë„ (%)</label>
                        <div class="stepper">
                            <input type="number" id="opacity-input" value="15" min="0" max="100" step="5">
                            <div class="stepper-btns"><button data-input="opacity-input" data-step="5">ğŸ”¼</button><button data-input="opacity-input" data-step="-5">ğŸ”½</button></div>
                        </div>
                    </div>
                    <div>
                        <label>ê°„ê²©</label>
                        <div class="stepper">
                           <input type="number" id="spacing-input" value="150" min="50" max="500" step="5">
                           <div class="stepper-btns"><button data-input="spacing-input" data-step="5">ğŸ”¼</button><button data-input="spacing-input" data-step="-5">ğŸ”½</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const uploadBox = document.getElementById('upload-box');
    const fileInput = document.getElementById('file-input');
    const workspace = document.getElementById('workspace');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const widthInput = document.getElementById('img-width');
    const heightInput = document.getElementById('img-height');
    const aspectLock = document.getElementById('aspect-lock');
    const watermarkTextInput = document.getElementById('watermark-text');
    const clearTextBtn = document.getElementById('clear-text-btn');
    const restoreTextBtn = document.getElementById('restore-text-btn');
    const positionGrid = document.getElementById('watermark-position');
    const downloadWashBtn = document.getElementById('wash-btn');
    const downloadRepairBtn = document.getElementById('repair-btn');
    const toggleDarkBtn = document.getElementById('toggleDarkBtn');
    const changeImageBtn = document.getElementById('change-image-btn');
    const mainLinkBtn = document.getElementById('main-link');

    let originalFile = null;
    let imageAspectRatio = 1;
    let isAspectLocked = true;
    const defaultWatermarkText = "ğŸ¥±ğŸ¥” Ai ì±„íŒ… ë‹¬ê¸€ ğŸ¦•ğŸ’¬";
    let previewCanvas = null;
    let settings = { text: defaultWatermarkText, position: 'center', size: 30, opacity: 15, spacing: 150 };

    // --- Functions ---
    const preventDefaults = e => { e.preventDefault(); e.stopPropagation(); };
    
    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) {
            alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
            return;
        }
        originalFile = file;
        const img = new Image();
        img.onload = () => {
            imageAspectRatio = img.naturalWidth / img.naturalHeight;
            widthInput.value = img.naturalWidth;
            heightInput.value = img.naturalHeight;
            
            uploadBox.style.display = 'none';
            imagePreviewContainer.innerHTML = `<img id="image-preview" src="${img.src}">`;
            workspace.style.display = 'block';

            const previewImg = document.getElementById('image-preview');
            
            if (previewCanvas) previewCanvas.remove();

            previewCanvas = document.createElement('canvas');
            previewCanvas.id = 'watermark-preview-canvas';
            imagePreviewContainer.appendChild(previewCanvas);

            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const { width, height } = entry.contentRect;
                    previewCanvas.style.width = `${width}px`;
                    previewCanvas.style.height = `${height}px`;
                    const dpr = window.devicePixelRatio || 1;
                    previewCanvas.width = width * dpr;
                    previewCanvas.height = height * dpr;
                    const ctx = previewCanvas.getContext('2d');
                    ctx.scale(dpr, dpr);
                    updatePreview();
                }
            });
            resizeObserver.observe(previewImg);
        }
        img.src = URL.createObjectURL(file);
    }
    
    function updatePreview() {
        if (!previewCanvas) return;
        const ctx = previewCanvas.getContext('2d');
        const canvasWidth = previewCanvas.width / (window.devicePixelRatio || 1);
        const canvasHeight = previewCanvas.height / (window.devicePixelRatio || 1);
        
        ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        drawWatermark(ctx, canvasWidth, canvasHeight);
    }

    function updateSetting(key, value) {
        settings[key] = value;
        localStorage.setItem('cleaner_settings', JSON.stringify(settings));
        updateRepairBtnState();
        updatePreview();
    }
    
    function updateRepairBtnState() {
        downloadRepairBtn.disabled = !settings.text;
    }

    function drawWatermark(ctx, width, height) {
        if (!settings.text) return;
        
        const dynamicFontSize = (settings.size / 1024) * width;
        ctx.fillStyle = `rgba(0, 0, 0, ${settings.opacity / 100})`;
        ctx.font = `bold ${dynamicFontSize}px "Pretendard", sans-serif`;
    
        if (settings.position === 'pattern') {
            const dynamicSpacing = (settings.spacing / 1024) * width;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.save();
            ctx.translate(width/2, height/2);
            ctx.rotate(-Math.PI / 12);
            
            const textWidth = ctx.measureText(settings.text).width;
            const effectiveSpacingX = Math.max(textWidth, dynamicSpacing * 1.8);
            const effectiveSpacingY = dynamicSpacing;
            
            const startX = -width; const startY = -height;
            const endX = width * 2; const endY = height * 2;

            for (let y = startY; y < endY; y += effectiveSpacingY) {
                for (let x = startX; x < endX; x += effectiveSpacingX) {
                     ctx.fillText(settings.text, x, y);
                }
            }
            ctx.restore();
        } else {
            const margin = width * 0.02;
            const positions = {
                'top-left': { x: margin, y: margin, align: 'left', baseline: 'top' },
                'top': { x: width / 2, y: margin, align: 'center', baseline: 'top' },
                'top-right': { x: width - margin, y: margin, align: 'right', baseline: 'top' },
                'left': { x: margin, y: height / 2, align: 'left', baseline: 'middle' },
                'center': { x: width / 2, y: height / 2, align: 'center', baseline: 'middle' },
                'right': { x: width - margin, y: height / 2, align: 'right', baseline: 'middle' },
                'bottom-left': { x: margin, y: height - margin, align: 'left', baseline: 'bottom' },
                'bottom-right': { x: width - margin, y: height - margin, align: 'right', baseline: 'bottom' },
            };
            const pos = positions[settings.position];
            if (pos) {
                ctx.textAlign = pos.align;
                ctx.textBaseline = pos.baseline;
                ctx.fillText(settings.text, pos.x, pos.y);
            }
        }
    }

    function processImage(addWatermark) {
        if (!originalFile) return;
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = parseInt(widthInput.value) || img.naturalWidth;
            canvas.height = parseInt(heightInput.value) || img.naturalHeight;
            
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            if (addWatermark) drawWatermark(ctx, canvas.width, canvas.height);
            
            canvas.toBlob((blob) => {
                const fileName = `cleaned_${originalFile.name.split('.').slice(0, -1).join('.')}.jpg`;
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            }, 'image/jpeg', 0.95);
        };
        img.src = URL.createObjectURL(originalFile);
    }
    
    function setupSteppers() {
        document.querySelectorAll('.stepper-btns button').forEach(button => {
            button.addEventListener('click', () => {
                const input = document.getElementById(button.dataset.input);
                const step = parseInt(button.dataset.step, 10);
                const min = parseInt(input.min, 10);
                const max = parseInt(input.max, 10);
                let value = parseInt(input.value, 10);
                value = isNaN(value) ? 0 : value;
                value += step;
                if (value < min) value = min;
                if (value > max) value = max;
                input.value = value;
                input.dispatchEvent(new Event('input'));
            });
        });
    }

    // --- Event Listeners ---
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadBox.addEventListener(e, preventDefaults, false));
    ['dragenter', 'dragover'].forEach(e => uploadBox.addEventListener(e, () => uploadBox.classList.add('dragover'), false));
    ['dragleave', 'drop'].forEach(e => uploadBox.addEventListener(e, () => uploadBox.classList.remove('dragover'), false));
    uploadBox.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
    uploadBox.addEventListener('click', () => fileInput.click());
    changeImageBtn.addEventListener('click', () => fileInput.click());

    aspectLock.addEventListener('click', () => {
        isAspectLocked = !isAspectLocked;
        aspectLock.textContent = isAspectLocked ? 'ğŸ”’' : 'ğŸ”“';
    });

    widthInput.addEventListener('input', () => { if (isAspectLocked) heightInput.value = Math.round(widthInput.value / imageAspectRatio); });
    heightInput.addEventListener('input', () => { if (isAspectLocked) widthInput.value = Math.round(heightInput.value * imageAspectRatio); });
    
    watermarkTextInput.addEventListener('input', e => updateSetting('text', e.target.value));
    clearTextBtn.addEventListener('click', () => { watermarkTextInput.value = ''; updateSetting('text', ''); });
    restoreTextBtn.addEventListener('click', () => { watermarkTextInput.value = defaultWatermarkText; updateSetting('text', defaultWatermarkText); });

    // âœ¨ ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì •
    positionGrid.addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;

        positionGrid.querySelector('.active')?.classList.remove('active');
        const button = e.target;
        button.classList.add('active');
        const newPosition = button.dataset.position;

        updateSetting('position', newPosition);

        const fontSizeInput = document.getElementById('font-size-input');
        const opacityInput = document.getElementById('opacity-input');

        if (newPosition === 'center') {
            fontSizeInput.value = 50;
            opacityInput.value = 30;
        } else if (newPosition === 'pattern') {
            fontSizeInput.value = 30;
            opacityInput.value = 15;
        }

        fontSizeInput.dispatchEvent(new Event('input'));
        opacityInput.dispatchEvent(new Event('input'));
    });
    
    document.getElementById('font-size-input').addEventListener('input', e => updateSetting('size', parseInt(e.target.value) || 0));
    document.getElementById('opacity-input').addEventListener('input', e => updateSetting('opacity', parseInt(e.target.value) || 0));
    document.getElementById('spacing-input').addEventListener('input', e => updateSetting('spacing', parseInt(e.target.value) || 0));

    downloadWashBtn.addEventListener('click', () => processImage(false));
    downloadRepairBtn.addEventListener('click', () => processImage(true));
    
    toggleDarkBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('cleaner_darkmode', document.body.classList.contains('dark'));
    });

    mainLinkBtn.addEventListener('click', () => {
        window.location.href = "https://toastout.github.io/toast/";
    });
    
    // --- Initial Load ---
    if (localStorage.getItem('cleaner_darkmode') === 'true') document.body.classList.add('dark');
    
    const savedSettings = localStorage.getItem('cleaner_settings');
    if (savedSettings) {
        try {
            const parsedSettings = JSON.parse(savedSettings);
            if (parsedSettings && typeof parsedSettings === 'object') {
                 settings = { ...settings, ...parsedSettings };
            }
        } catch (e) {
            console.error("ì €ì¥ëœ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", e);
            localStorage.removeItem('cleaner_settings');
        }
    }
    
    watermarkTextInput.value = settings.text;
    positionGrid.querySelector('.active')?.classList.remove('active');
    const activeButton = positionGrid.querySelector(`[data-position="${settings.position}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
        // âœ¨ í˜ì´ì§€ ë¡œë“œ ì‹œì ì—ë„ ê¸°ë³¸ê°’ ì ìš©
        if (settings.position === 'center') {
            settings.size = 50;
            settings.opacity = 30;
        } else if (settings.position === 'pattern') {
            settings.size = 30;
            settings.opacity = 15;
        }
    } else {
        positionGrid.querySelector('[data-position="center"]').classList.add('active');
        settings.position = 'center';
        settings.size = 50;
        settings.opacity = 30;
    }
    document.getElementById('font-size-input').value = settings.size;
    document.getElementById('opacity-input').value = settings.opacity;
    document.getElementById('spacing-input').value = settings.spacing;

    updateRepairBtnState();
    setupSteppers();
});
</script>
</body>
</html>

